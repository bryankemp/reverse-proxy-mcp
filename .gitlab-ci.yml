stages:
  - lint
  - test
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DOCKER_REGISTRY: "registry.gitlab.com"
  DOCKER_IMAGE: "${DOCKER_REGISTRY}/kempville/reverse-proxy-mcp"
  PYTHON_VERSION: "3.11"
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fastest"

cache:
  paths:
    - .cache/pip
    - .venv

image: python:3.11

before_script:
  - python -m venv .venv
  - source .venv/bin/activate
  - pip install --upgrade pip setuptools wheel
  - pip install -e ".[dev]"

# Linting and Code Quality
lint:black:
  stage: lint
  script:
    - black --check src tests
  allow_failure: false

lint:ruff:
  stage: lint
  script:
    - ruff check src tests
  allow_failure: false

lint:mypy:
  stage: lint
  script:
    - mypy src
  allow_failure: false

# Testing
test:unit:
  stage: test
  script:
    - pytest -m unit --cov=src --cov-report=term-missing --cov-report=xml
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

test:integration:
  stage: test
  script:
    - pytest -m integration --cov=src --cov-report=term-missing
  allow_failure: true

test:e2e:
  stage: test
  script:
    - pytest -m e2e --cov=src --cov-report=term-missing
  allow_failure: true

# Build Docker Image
build:docker:
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_SHA -f Dockerfile.api .
    - docker tag $DOCKER_IMAGE:$CI_COMMIT_SHA $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHA
    - docker push $DOCKER_IMAGE:latest
  only:
    - main
    - develop
    - tags

# Security Scanning (optional)
security:dependencies:
  stage: lint
  script:
    - pip install safety
    - safety check --json
  allow_failure: true

# Code quality metrics (optional)
pages:
  stage: deploy
  script:
    - pytest --cov=src --cov-report=html
    - mkdir -p public
    - cp -r htmlcov/* public/
  artifacts:
    paths:
      - public
  only:
    - main
  allow_failure: true
